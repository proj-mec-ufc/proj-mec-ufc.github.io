<html>
<head>
    <script src="../jquery-3.6.0.js"></script>

    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
    <link rel="stylesheet" type="text/css" href=".././dist/dynamic_table.css" />

    <link rel="stylesheet" type="text/css" href="../chartist-js/dist/chartist.css" />
    <script src="../chartist-js/dist/chartist.js"></script>
</head>

<body>
    <div id="dt1" class="dynamic_table" graph="on"></div>
    <div><input id="btGraph" class="chart" refer="dt1" type="button" value="Gráfico" /></div>
    <div id="message"></div><br/>
    
    <div class="ct-chart ct-golden-section" id="chart1"></div>
</body>

<script>
    // ----- Values passed to the dynamic table

    let tableData = [
        {Município:"Caucaia", Distância:""},
        {Município:"Sobral", Distância:""},
        {Município:"Quixeramobim", Distância:""},
        {Município:"Maranguape", Distância:""},
    ];

    let cols = [
        {field:"Município"},
        {field:"Distância",  editor:"input" },
    ];

    let correctValues = [
        {Município:"Caucaia", Distância:"17"},
        {Município:"Sobral", Distância:"240"},
        {Município:"Quixeramobim", Distância:"203"},
        {Município:"Maranguape", Distância:"27"},
    ];

    // -------------------------------------------

    function getLine(value) {
        for(var i=0; i<correctValues.length; i++) 
            if(correctValues[i].Município==value) // ****** automate
                return i
        return -1;
    };

    function verify(tableData) {
        let count = 0;
        for(var i=0; i<tableData.length; i++){
            //if is number
            let value = tableData[i].Distância; // ***** automate
            if (!(value===""))
                if (!isNaN(parseInt(value, 10))) 
                    count++;
        }

        if (count == tableData.length)
            return true;
        else
            return false;
    };

    function removeFField(tableData) {
        let graphData = [];
        for(var i=0; i<tableData.length; i++)
            graphData.push(tableData[i].Distância); // ***** automate
        return graphData;
    };

    $( document ).ready(function() {
        // add title and sorter
        for (let i=0; i<cols.length; i++){
            cols[i]["title"] = cols[i]["field"];
            cols[i]["sorter"] = "string";
        }

        // ***** automate 
        // create tabulator
        var table = new Tabulator("#dt1", {
            data: tableData,
            layout:"fitColumns",
            columns: cols,
            ajaxConfig: {
                method:"post",
                headers: {
                    "Content-type": 'application/json; charset=utf-8',
                },
            },
        });

        // when cell was edited
        table.on("cellEdited", function(cell){ 
            let col = cell.getColumn();
            let row = cell.getRow();
            let field = col.getField();
            let digitedValue = row.getData()[field];
            let rowNumber = getLine(row.getData()['Município']); // ****** automate
            let correctValue;

            // review to automate
            switch (field) {
            case "Distância":   
                correctValue = correctValues[rowNumber].Distância;
                break;
            }
            
            if (correctValue==digitedValue){
                cell.getElement().style.backgroundColor = "#adf7f6";
            }
            else {
                // accept zero if field is empty
                if ((correctValue=='')&&(digitedValue=='0'))
                    cell.getElement().style.backgroundColor = "#adf7f6";
                else {
                    cell.getElement().style.backgroundColor = "";
                }
            }
        });

        $( ".chart" ).click(function() {
            let tableData = table.getData();
            let filled = verify(tableData);
  
            // if editable fields are full filed
            if (!filled) {
                document.getElementById("message").innerText = "Preencha todos os campos.";
            }
            else{

                tableData = removeFField(tableData);

                // ***** automate
                var data = {
                    labels: [''],
                    series: [ tableData ]
                    };
                var options = {
                    showPoint: true,
                    lineSmooth: false,
                    axisX: {
                        showGrid: true,
                        showLabel: true
                    }
                };
                var responsiveOptions = [
                    ['screen and (min-width: 321px) and (max-width: 1024px)', {
                        seriesBarDistance: 8, //10,
                        axisX: {
                        labelInterpolationFnc: function (value) {
                            return value;
                        }
                        }
                    }],
                    ['screen and (max-width: 640px)', {
                        seriesBarDistance: 4, //5,
                        axisX: {
                        labelInterpolationFnc: function (value) {
                            return value[0];
                        }
                        }
                    }]
                ];
                new Chartist.Line('#chart1', data, options, responsiveOptions);
            }
        });
    });
</script>

</html>
